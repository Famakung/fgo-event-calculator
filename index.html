<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FGO Event Shop Calculator</title>
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=stylesheet"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #f8f9fc;
        --card: #ffffff;
        --text: #1a1a2e;
        --text-secondary: #6b7280;
        --border: #e5e7eb;
        --bronze: #cd7f32;
        --bronze-bg: #fef3e7;
        --bronze-text: #92400e;
        --silver: #71717a;
        --silver-bg: #f4f4f5;
        --silver-text: #3f3f46;
        --gold: #eab308;
        --gold-bg: #fefce8;
        --gold-text: #854d0e;
        --accent: #6366f1;
        --accent-light: #eef2ff;
        --shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
        --radius: 16px;
        --radius-sm: 10px;
      }

      /* Tier-based theming via data attributes */
      [data-tier="bronze"] {
        --tier-color: var(--bronze);
        --tier-bg: var(--bronze-bg);
        --tier-text: var(--bronze-text);
      }
      [data-tier="silver"] {
        --tier-color: var(--silver);
        --tier-bg: var(--silver-bg);
        --tier-text: var(--silver-text);
      }
      [data-tier="gold"] {
        --tier-color: var(--gold);
        --tier-bg: var(--gold-bg);
        --tier-text: var(--gold-text);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        min-height: 100vh;
        background: var(--bg);
        font-family: "DM Sans", sans-serif;
        color: var(--text);
        line-height: 1.5;
      }

      .container {
        max-width: 720px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      /* Header */
      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .badge {
        display: inline-block;
        background: var(--accent-light);
        color: var(--accent);
        font-size: 0.75rem;
        font-weight: 600;
        padding: 6px 14px;
        border-radius: 100px;
        margin-bottom: 16px;
        letter-spacing: 0.02em;
      }

      .title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text);
        margin-bottom: 8px;
      }

      .subtitle {
        font-size: 1rem;
        color: var(--text-secondary);
      }

      /* Cards */
      .card {
        background: var(--card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 28px;
        margin-bottom: 20px;
        border: 1px solid var(--border);
      }

      .card-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 20px;
      }

      /* Material Grid */
      .materials-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        min-width: 0;
      }

      .material-card {
        padding: 16px 12px;
        border-radius: var(--radius-sm);
        text-align: center;
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
        min-width: 0;
        overflow: hidden;
      }

      .material-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
      }

      .material-card[data-tier] {
        background: var(--tier-bg);
      }

      .material-icon-wrapper {
        width: 56px;
        height: 60px;
        margin: 0 auto 10px;
        position: relative;
      }

      .material-icon {
        width: 56px;
        height: 60px;
        border-radius: 6px;
        overflow: hidden;
        background: #e5e7eb;
        position: relative;
      }

      .material-icon .bg-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .material-icon .fg-layer {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 50px;
        height: 50px;
        transform: translate(-50%, -50%);
        object-fit: contain;
      }

      .material-name {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 16px;
      }

      .material-card[data-tier] .material-name {
        color: var(--tier-text);
      }

      /* Inputs */
      .input-row {
        display: flex;
        flex-direction: row;
        align-items: center;
        gap: 6px;
        margin-bottom: 6px;
      }

      .input-row:last-child {
        margin-bottom: 0;
      }

      .input-label {
        font-size: 0.65rem;
        color: var(--text-secondary);
        font-weight: 500;
        min-width: 38px;
        text-align: left;
      }

      .input-field {
        flex: 1;
        min-width: 0;
        background: white;
        border: 1.5px solid var(--border);
        border-radius: 6px;
        padding: 6px 8px;
        font-family: "Space Mono", monospace;
        font-size: 0.8rem;
        color: var(--text);
        text-align: center;
        transition:
          border-color 0.2s ease,
          box-shadow 0.2s ease;
      }

      .input-field:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-light);
      }

      /* Drop Rates */
      .drop-rates-3col {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
      }

      .rate-item {
        background: var(--bg);
        padding: 16px;
        border-radius: var(--radius-sm);
      }

      .rate-label {
        font-size: 0.75rem;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .rate-icon {
        width: 18px;
        height: 18px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 700;
      }

      .rate-icon.more {
        background: #22c55e;
        color: white;
      }
      .rate-icon.less {
        background: #f97316;
        color: white;
      }

      .rate-input {
        width: 100%;
        background: white;
        border: 1.5px solid var(--border);
        border-radius: 8px;
        padding: 10px 12px;
        font-family: "Space Mono", monospace;
        font-size: 1rem;
        color: var(--text);
        transition:
          border-color 0.2s ease,
          box-shadow 0.2s ease;
      }

      .rate-input:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 3px var(--accent-light);
      }

      .calculated-value {
        font-family: "Space Mono", monospace;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text);
        text-align: center;
        padding: 10px 12px;
      }

      /* Base Row */
      .base-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }

      .base-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .base-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-secondary);
      }

      .base-input {
        width: 90px;
        text-align: center;
      }

      /* Quest Drops Grid */
      .quest-drops-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }

      .quest-drops-item {
        background: var(--bg);
        padding: 16px;
        border-radius: var(--radius-sm);
        border: 2px solid transparent;
      }

      .quest-drops-item[data-tier] {
        border-color: var(--tier-color);
      }

      .quest-drops-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        margin-bottom: 12px;
      }

      .quest-drops-item[data-tier] .quest-drops-title {
        color: var(--tier-color);
      }

      .drop-line {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 0;
      }

      .mini-icon {
        width: 28px;
        height: 30px;
        flex-shrink: 0;
        position: relative;
      }

      .mini-icon .bg-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .mini-icon .fg-layer {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 24px;
        height: 24px;
        transform: translate(-50%, -50%);
        object-fit: contain;
      }

      .drop-material {
        font-size: 0.75rem;
        color: var(--text-secondary);
        flex: 1;
      }

      .drop-value {
        font-family: "Space Mono", monospace;
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--text);
      }

      /* Button */
      .calculate-btn {
        width: 100%;
        padding: 16px 32px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: var(--radius-sm);
        font-family: "DM Sans", sans-serif;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .calculate-btn:hover {
        background: #4f46e5;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      }

      .calculate-btn:active {
        transform: translateY(0);
      }

      .btn-icon {
        font-size: 1.2rem;
      }

      /* Results */
      .results {
        display: none;
      }

      .results.visible {
        display: block;
        animation: fadeUp 0.4s ease;
      }

      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(16px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Deficit */
      .deficit-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-bottom: 20px;
      }

      .deficit-item {
        text-align: center;
        padding: 16px;
        border-radius: var(--radius-sm);
      }

      .deficit-item[data-tier] {
        background: var(--tier-bg);
      }

      .deficit-label {
        font-size: 0.7rem;
        color: var(--text-secondary);
        margin-bottom: 4px;
      }

      .deficit-value {
        font-family: "Space Mono", monospace;
        font-size: 1.5rem;
        font-weight: 700;
      }

      .deficit-item[data-tier] .deficit-value {
        color: var(--tier-color);
      }

      /* Quest Results */
      .quest-results {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-radius: var(--radius-sm);
        padding: 24px;
      }

      .quest-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-align: center;
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .quest-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }

      .quest-item {
        background: white;
        padding: 20px 16px;
        border-radius: var(--radius-sm);
        text-align: center;
        border: 2px solid transparent;
        transition: all 0.2s ease;
      }

      .quest-item[data-tier] {
        border-color: var(--tier-color);
      }

      .quest-item:hover {
        transform: scale(1.02);
      }

      .quest-name {
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .quest-item[data-tier] .quest-name {
        color: var(--tier-color);
      }

      .quest-count {
        font-family: "Space Mono", monospace;
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
        color: var(--text);
      }

      .quest-label {
        font-size: 0.7rem;
        color: var(--text-secondary);
        margin-top: 4px;
      }

      /* Footer */
      .footer {
        text-align: center;
        margin-top: 32px;
        color: var(--text-secondary);
        font-size: 0.8rem;
      }

      /* Responsive */
      @media (max-width: 600px) {
        .container {
          padding: 24px 16px;
        }

        .title {
          font-size: 1.5rem;
        }

        .materials-grid,
        .deficit-grid,
        .quest-grid {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .drop-rates-3col,
        .quest-drops-grid {
          grid-template-columns: 1fr;
        }

        .card {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <div class="badge">Event Shop Planner</div>
        <h1 class="title">FGO Calculator</h1>
        <p class="subtitle">Optimize your event item farming</p>
      </header>

      <div class="card">
        <div class="card-title">Shop Requirements</div>
        <div class="materials-grid">
          <div class="material-card" data-tier="bronze">
            <div class="material-icon-wrapper">
              <div class="material-icon" id="bronzeIcon"></div>
            </div>
            <div class="input-row">
              <label class="input-label">Require</label>
              <input
                type="number"
                class="input-field"
                id="bronzeNeed"
                value="0"
              />
            </div>
            <div class="input-row">
              <label class="input-label">Held</label>
              <input
                type="number"
                class="input-field"
                id="bronzeHave"
                value="0"
              />
            </div>
            <div class="input-row">
              <label class="input-label">Bonus</label>
              <input
                type="number"
                class="input-field"
                id="bronzeBonus"
                value="0"
              />
            </div>
          </div>

          <div class="material-card" data-tier="silver">
            <div class="material-icon-wrapper">
              <div class="material-icon" id="silverIcon"></div>
            </div>
            <div class="input-row">
              <label class="input-label">Require</label>
              <input
                type="number"
                class="input-field"
                id="silverNeed"
                value="0"
              />
            </div>
            <div class="input-row">
              <label class="input-label">Held</label>
              <input
                type="number"
                class="input-field"
                id="silverHave"
                value="0"
              />
            </div>
            <div class="input-row">
              <label class="input-label">Bonus</label>
              <input
                type="number"
                class="input-field"
                id="silverBonus"
                value="0"
              />
            </div>
          </div>

          <div class="material-card" data-tier="gold">
            <div class="material-icon-wrapper">
              <div class="material-icon" id="goldIcon"></div>
            </div>
            <div class="input-row">
              <label class="input-label">Require</label>
              <input
                type="number"
                class="input-field"
                id="goldNeed"
                value="0"
              />
            </div>
            <div class="input-row">
              <label class="input-label">Held</label>
              <input
                type="number"
                class="input-field"
                id="goldHave"
                value="0"
              />
            </div>
            <div class="input-row">
              <label class="input-label">Bonus</label>
              <input
                type="number"
                class="input-field"
                id="goldBonus"
                value="0"
              />
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Drop Rates per Run</div>
        <div class="base-row">
          <div class="base-item">
            <label class="base-label">Base</label>
            <input
              type="number"
              class="rate-input base-input"
              id="baseDrop"
              value="3"
            />
          </div>
          <div class="base-item">
            <label class="base-label">Primary %</label>
            <input
              type="number"
              class="rate-input base-input"
              id="primaryMultiplier"
              value="1500"
            />
          </div>
          <div class="base-item">
            <label class="base-label">Secondary %</label>
            <input
              type="number"
              class="rate-input base-input"
              id="secondaryMultiplier"
              value="225"
            />
          </div>
        </div>
        <div class="quest-drops-grid">
          <div class="quest-drops-item" data-tier="bronze">
            <div class="quest-drops-title">Bronze Quest</div>
            <div class="drop-line">
              <span class="mini-icon" id="bronzeQuest_bronze_icon"></span>
              <span class="drop-material" id="bronzeQuest_bronze_label"
                >3(+0)</span
              >
              <span class="drop-value" id="bronzeQuest_bronze">45</span>
            </div>
            <div class="drop-line">
              <span class="mini-icon" id="bronzeQuest_silver_icon"></span>
              <span class="drop-material" id="bronzeQuest_silver_label"
                >3(+0)</span
              >
              <span class="drop-value" id="bronzeQuest_silver">6.75</span>
            </div>
          </div>
          <div class="quest-drops-item" data-tier="silver">
            <div class="quest-drops-title">Silver Quest</div>
            <div class="drop-line">
              <span class="mini-icon" id="silverQuest_silver_icon"></span>
              <span class="drop-material" id="silverQuest_silver_label"
                >3(+0)</span
              >
              <span class="drop-value" id="silverQuest_silver">45</span>
            </div>
            <div class="drop-line">
              <span class="mini-icon" id="silverQuest_gold_icon"></span>
              <span class="drop-material" id="silverQuest_gold_label"
                >3(+0)</span
              >
              <span class="drop-value" id="silverQuest_gold">6.75</span>
            </div>
          </div>
          <div class="quest-drops-item" data-tier="gold">
            <div class="quest-drops-title">Gold Quest</div>
            <div class="drop-line">
              <span class="mini-icon" id="goldQuest_gold_icon"></span>
              <span class="drop-material" id="goldQuest_gold_label">3(+0)</span>
              <span class="drop-value" id="goldQuest_gold">45</span>
            </div>
            <div class="drop-line">
              <span class="mini-icon" id="goldQuest_bronze_icon"></span>
              <span class="drop-material" id="goldQuest_bronze_label"
                >3(+0)</span
              >
              <span class="drop-value" id="goldQuest_bronze">6.75</span>
            </div>
          </div>
        </div>
      </div>

      <button class="calculate-btn" onclick="calculate()">
        Calculate Quest Runs
      </button>

      <div class="results" id="results">
        <div class="card" style="margin-top: 20px">
          <div class="card-title">Items Needed</div>
          <div class="deficit-grid">
            <div class="deficit-item" data-tier="bronze">
              <div class="deficit-label">Bronze</div>
              <div class="deficit-value" id="bronzeDeficit">0</div>
            </div>
            <div class="deficit-item" data-tier="silver">
              <div class="deficit-label">Silver</div>
              <div class="deficit-value" id="silverDeficit">0</div>
            </div>
            <div class="deficit-item" data-tier="gold">
              <div class="deficit-label">Gold</div>
              <div class="deficit-value" id="goldDeficit">0</div>
            </div>
          </div>

          <div class="quest-results">
            <div class="quest-title">Recommended Quest Runs</div>
            <div class="quest-grid">
              <div class="quest-item" data-tier="bronze">
                <div class="quest-name">Bronze Quest</div>
                <div class="quest-count" id="bronzePlay">0</div>
                <div class="quest-label">runs</div>
              </div>
              <div class="quest-item" data-tier="silver">
                <div class="quest-name">Silver Quest</div>
                <div class="quest-count" id="silverPlay">0</div>
                <div class="quest-label">runs</div>
              </div>
              <div class="quest-item" data-tier="gold">
                <div class="quest-name">Gold Quest</div>
                <div class="quest-count" id="goldPlay">0</div>
                <div class="quest-label">runs</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer class="footer">Fate/Grand Order Event Shop Calculator</footer>
    </div>

    <script>
      // Material tiers
      const TIERS = ["bronze", "silver", "gold"];

      // Input fields per tier
      const TIER_FIELDS = ["Need", "Have", "Bonus"];

      // Default values
      const DEFAULTS = {
        bronze: { Need: 0, Have: 0, Bonus: 0 },
        silver: { Need: 0, Have: 0, Bonus: 0 },
        gold: { Need: 0, Have: 0, Bonus: 0 },
        baseDrop: 3,
        primaryMultiplier: 1500,
        secondaryMultiplier: 225,
      };

      // Icon URLs
      const ICON_URLS = {
        bronze: {
          bg: "https://apps.atlasacademy.io/db/assets/listframes1_bg-CB5tQlCX.png",
          fg: "https://static.atlasacademy.io/JP/Items/94153901.png",
        },
        silver: {
          bg: "https://apps.atlasacademy.io/db/assets/listframes2_bg-BcVjjli0.png",
          fg: "https://static.atlasacademy.io/JP/Items/94153902.png",
        },
        gold: {
          bg: "https://apps.atlasacademy.io/db/assets/listframes3_bg-CFbSxrKK.png",
          fg: "https://static.atlasacademy.io/JP/Items/94153903.png",
        },
      };

      // Quest drop configuration: which material drops as primary/secondary
      const QUEST_DROPS = {
        bronze: { primary: "bronze", secondary: "silver" },
        silver: { primary: "silver", secondary: "gold" },
        gold: { primary: "gold", secondary: "bronze" },
      };

      // Helper: create icon HTML
      function createIconHtml(tier) {
        return `<img class="bg-layer" src="${ICON_URLS[tier].bg}" alt="${tier} bg">
                <img class="fg-layer" src="${ICON_URLS[tier].fg}" alt="${tier} fg">`;
      }

      // Load all icons
      function loadIcons() {
        // Main icons
        TIERS.forEach((tier) => {
          document.getElementById(`${tier}Icon`).innerHTML =
            createIconHtml(tier);
        });

        // Quest mini icons
        Object.entries(QUEST_DROPS).forEach(([quest, drops]) => {
          [drops.primary, drops.secondary].forEach((material) => {
            const iconEl = document.getElementById(
              `${quest}Quest_${material}_icon`,
            );
            if (iconEl) iconEl.innerHTML = createIconHtml(material);
          });
        });
      }

      // Get all form values as object
      function getFormData() {
        const data = {};
        TIERS.forEach((tier) => {
          TIER_FIELDS.forEach((field) => {
            data[`${tier}${field}`] = document.getElementById(
              `${tier}${field}`,
            ).value;
          });
        });
        data.baseDrop = document.getElementById("baseDrop").value;
        data.primaryMultiplier =
          document.getElementById("primaryMultiplier").value;
        data.secondaryMultiplier = document.getElementById(
          "secondaryMultiplier",
        ).value;
        return data;
      }

      // Save data to localStorage
      function saveData() {
        localStorage.setItem(
          "fgo_calculator_data",
          JSON.stringify(getFormData()),
        );
      }

      // Load data from localStorage
      function loadData() {
        const saved = localStorage.getItem("fgo_calculator_data");
        const data = saved ? JSON.parse(saved) : {};

        // Load tier fields
        TIERS.forEach((tier) => {
          TIER_FIELDS.forEach((field) => {
            const key = `${tier}${field}`;
            document.getElementById(key).value =
              data[key] ?? DEFAULTS[tier][field];
          });
        });

        // Load other fields
        document.getElementById("baseDrop").value =
          data.baseDrop ?? DEFAULTS.baseDrop;
        document.getElementById("primaryMultiplier").value =
          data.primaryMultiplier ?? DEFAULTS.primaryMultiplier;
        document.getElementById("secondaryMultiplier").value =
          data.secondaryMultiplier ?? DEFAULTS.secondaryMultiplier;

        updateDropDisplay();
        loadIcons();
      }

      // Get parsed input values with validation
      function getInputValues() {
        const clamp = (val, min = 0) => Math.max(min, parseFloat(val) || 0);
        const values = {
          base: clamp(document.getElementById("baseDrop").value),
        };
        values.primaryMult =
          clamp(document.getElementById("primaryMultiplier").value, 1) / 100;
        values.secondaryMult =
          clamp(document.getElementById("secondaryMultiplier").value, 1) / 100;

        TIERS.forEach((tier) => {
          values[`${tier}Bonus`] = clamp(
            document.getElementById(`${tier}Bonus`).value,
          );
        });

        return values;
      }

      // Update drop rate display
      function updateDropDisplay() {
        const {
          base,
          primaryMult,
          secondaryMult,
          bronzeBonus,
          silverBonus,
          goldBonus,
        } = getInputValues();
        const bonuses = {
          bronze: bronzeBonus,
          silver: silverBonus,
          gold: goldBonus,
        };

        // Calculate and display drops for each quest type
        TIERS.forEach((questTier) => {
          const drops = QUEST_DROPS[questTier];
          const primaryDrop =
            Math.round((base + bonuses[drops.primary]) * primaryMult * 100) /
            100;
          const secondaryDrop =
            Math.round(
              (base + bonuses[drops.secondary]) * secondaryMult * 100,
            ) / 100;

          document.getElementById(
            `${questTier}Quest_${drops.primary}_label`,
          ).textContent = `${base}(+${bonuses[drops.primary]})`;
          document.getElementById(
            `${questTier}Quest_${drops.secondary}_label`,
          ).textContent = `${base}(+${bonuses[drops.secondary]})`;
          document.getElementById(
            `${questTier}Quest_${drops.primary}`,
          ).textContent = primaryDrop;
          document.getElementById(
            `${questTier}Quest_${drops.secondary}`,
          ).textContent = secondaryDrop;
        });
      }

      // Initialize event listeners
      document.addEventListener("DOMContentLoaded", function () {
        loadData();

        const inputIds = [
          "baseDrop",
          "primaryMultiplier",
          "secondaryMultiplier",
          ...TIERS.map((t) => `${t}Bonus`),
        ];
        inputIds.forEach((id) => {
          document
            .getElementById(id)
            .addEventListener("input", updateDropDisplay);
        });
      });

      function calculate() {
        saveData();

        const {
          base,
          primaryMult,
          secondaryMult,
          bronzeBonus,
          silverBonus,
          goldBonus,
        } = getInputValues();
        const bonuses = {
          bronze: bronzeBonus,
          silver: silverBonus,
          gold: goldBonus,
        };

        // Get needs and haves
        const needs = {},
          haves = {};
        TIERS.forEach((tier) => {
          needs[tier] = Math.max(
            0,
            parseInt(document.getElementById(`${tier}Need`).value) || 0,
          );
          haves[tier] = Math.max(
            0,
            parseInt(document.getElementById(`${tier}Have`).value) || 0,
          );
        });

        // Calculate deficits
        const deficits = {};
        TIERS.forEach((tier) => {
          deficits[tier] = needs[tier] - haves[tier];
        });
        const originalDeficits = { ...deficits };

        // Calculate drop rates per quest (rounded to avoid floating-point issues)
        const dropRates = {};
        TIERS.forEach((questTier) => {
          const drops = QUEST_DROPS[questTier];
          dropRates[questTier] = {
            primary: {
              tier: drops.primary,
              rate:
                Math.round(
                  (base + bonuses[drops.primary]) * primaryMult * 100,
                ) / 100,
            },
            secondary: {
              tier: drops.secondary,
              rate:
                Math.round(
                  (base + bonuses[drops.secondary]) * secondaryMult * 100,
                ) / 100,
            },
          };
        });

        // Calculate runs needed with safety limit
        const runs = { bronze: 0, silver: 0, gold: 0 };
        const MAX_ITERATIONS = 10000;
        let iterations = 0;

        while (
          TIERS.some((t) => deficits[t] > 0) &&
          iterations < MAX_ITERATIONS
        ) {
          iterations++;
          // Find highest deficit
          const maxTier = TIERS.reduce((a, b) =>
            deficits[a] >= deficits[b] ? a : b,
          );

          // Run that quest
          const quest = dropRates[maxTier];
          deficits[quest.primary.tier] -= quest.primary.rate;
          deficits[quest.secondary.tier] -= quest.secondary.rate;
          runs[maxTier]++;
        }

        // Show results
        const resultsSection = document.getElementById("results");
        resultsSection.classList.add("visible");

        // Update deficit display
        TIERS.forEach((tier) => {
          document.getElementById(`${tier}Deficit`).textContent = Math.max(
            0,
            originalDeficits[tier],
          );
          animateCount(`${tier}Play`, runs[tier]);
        });

        setTimeout(() => {
          resultsSection.scrollIntoView({
            behavior: "smooth",
            block: "center",
          });
        }, 100);
      }

      function animateCount(elementId, targetValue) {
        const element = document.getElementById(elementId);
        const duration = 600;
        const startTime = performance.now();

        function update(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const easeOut = 1 - Math.pow(1 - progress, 3);
          element.textContent = Math.round(targetValue * easeOut);

          if (progress < 1) requestAnimationFrame(update);
        }

        requestAnimationFrame(update);
      }
    </script>
  </body>
</html>
